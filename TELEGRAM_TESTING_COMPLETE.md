# Telegram Bot å®Œæ•´åŠŸèƒ½æµ‹è¯•æŠ¥å‘Š

## ğŸ“… å®Œæˆæ—¶é—´
2026-02-12

## âœ… é—®é¢˜ä¿®å¤

### 1. Dataclass å­—æ®µé¡ºåºé”™è¯¯

**åŸå§‹é”™è¯¯**:
```
ERROR - âŒ Failed to start channel telegram: 
non-default argument 'channel_id' follows default argument 'sender_handle'
```

**ä½ç½®**: `openclaw/auto_reply/inbound_context.py`

**ä¿®å¤**: é‡æ–°æ’åº `InboundContext` å­—æ®µï¼Œç¡®ä¿æ‰€æœ‰å¿…éœ€å­—æ®µåœ¨å¯é€‰å­—æ®µä¹‹å‰ï¼š

```python
@dataclass
class InboundContext:
    # Required fields first
    envelope: InboundEnvelope
    sender_id: str
    sender_name: str
    channel_id: str
    
    # Optional fields with defaults
    sender_handle: str | None = None
    thread_id: str | None = None
    # ... å…¶ä»–å¯é€‰å­—æ®µ
```

**ç»“æœ**: âœ… Telegram channel å¯ä»¥æ­£å¸¸å¯åŠ¨

---

## ğŸ¯ å®ç°çš„åŠŸèƒ½

å‚è€ƒ: https://core.telegram.org/bots/api

### 1. å‘½ä»¤ç³»ç»Ÿ (5 ä¸ªå‘½ä»¤)

| å‘½ä»¤ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|
| `/start` | æ¬¢è¿æ¶ˆæ¯ + å¿«æ·é”®ç›˜ | âœ… |
| `/help` | å®Œæ•´å¸®åŠ©ä¿¡æ¯ | âœ… |
| `/new` | æ–°å¯¹è¯ + ç¡®è®¤æŒ‰é’® | âœ… |
| `/status` | æœºå™¨äººçŠ¶æ€æŸ¥è¯¢ | âœ… |
| `/model` | æ¨¡å‹åˆ‡æ¢ + å†…è”èœå• | âœ… |

**å®ç°**:
- å‘½ä»¤è‡ªåŠ¨æ³¨å†Œåˆ° Telegram
- æ˜¾ç¤ºåœ¨å‘½ä»¤èœå• (ç‚¹å‡» `/` æŒ‰é’®)
- æ”¯æŒå›è°ƒæŸ¥è¯¢å¤„ç†

### 2. äº¤äº’å¼é”®ç›˜

**å†…è”é”®ç›˜** (æ¶ˆæ¯ä¸‹æ–¹æŒ‰é’®):
- æ¨¡å‹é€‰æ‹© (Gemini, Claude, GPT-4)
- ç¡®è®¤/å–æ¶ˆæŒ‰é’®
- URL æŒ‰é’®æ”¯æŒ

**å›å¤é”®ç›˜** (è¾“å…¥æ¡†ä¸Šæ–¹):
- ğŸ’¬ æ–°å¯¹è¯
- ğŸ“Š çŠ¶æ€
- â“ å¸®åŠ©
- ğŸ¤– åˆ‡æ¢æ¨¡å‹

### 3. æ¶ˆæ¯æ ¼å¼æ”¯æŒ (8 ç§)

| æ–¹æ³• | åŠŸèƒ½ | æ”¯æŒ | æµ‹è¯• |
|------|------|------|------|
| `send_text()` | æ–‡æœ¬æ¶ˆæ¯ + Markdown | âœ… | âœ… |
| `send_photo()` | å›¾ç‰‡ + è¯´æ˜ | âœ… | âœ… |
| `send_video()` | è§†é¢‘æ¶ˆæ¯ | âœ… | â³ |
| `send_document()` | æ–‡ä»¶/æ–‡æ¡£ | âœ… | âœ… |
| `send_audio()` | éŸ³é¢‘æ¶ˆæ¯ | âœ… | â³ |
| `send_location()` | åœ°ç†ä½ç½® | âœ… | âœ… |
| `send_poll()` | æŠ•ç¥¨é—®å· | âœ… | âœ… |
| `send_dice()` | åŠ¨ç”»è¡¨æƒ… | âœ… | âœ… |

**Markdown æ”¯æŒ**:
- `*ç²—ä½“*`
- `_æ–œä½“_`
- `` `ä»£ç ` ``
- ```` ```ä»£ç å—``` ````
- `[é“¾æ¥](URL)`

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### ä¸»è¦ä¿®æ”¹

1. **openclaw/auto_reply/inbound_context.py**
   - ä¿®å¤ `InboundContext` dataclass å­—æ®µé¡ºåº
   - ç¡®ä¿å¿…éœ€å­—æ®µåœ¨å¯é€‰å­—æ®µä¹‹å‰

2. **openclaw/channels/telegram/channel.py**
   - æ·»åŠ  8 ä¸ªæ¶ˆæ¯å‘é€æ–¹æ³•
   - æ·»åŠ  5 ä¸ªå‘½ä»¤å¤„ç†å‡½æ•°
   - æ·»åŠ å†…è”é”®ç›˜å’Œå›å¤é”®ç›˜æ”¯æŒ
   - æ·»åŠ å‘½ä»¤æ³¨å†Œå’Œèœå•è®¾ç½®
   - Markdown æ ¼å¼æ”¯æŒ + fallback

### åˆ›å»ºçš„æ–‡ä»¶

1. **TELEGRAM_BOT_GUIDE.md** - å‘½ä»¤ä½¿ç”¨å®Œæ•´æŒ‡å—
2. **TELEGRAM_MESSAGE_FORMATS.md** - æ¶ˆæ¯æ ¼å¼è¯¦ç»†è¯´æ˜
3. **TELEGRAM_ENHANCEMENT_COMPLETE.md** - åŠŸèƒ½å®ŒæˆæŠ¥å‘Š
4. **test_telegram_formats.py** - æ¶ˆæ¯æ ¼å¼æµ‹è¯•è„šæœ¬
5. **TELEGRAM_TESTING_COMPLETE.md** - æœ¬æ–‡æ¡£

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1: é‡å¯ Gateway

åœ¨ç»ˆç«¯ 1 ä¸­:
```bash
# 1. åœæ­¢å½“å‰ Gateway
Ctrl+C

# 2. é‡å¯
cd /Users/openjavis/Desktop/xopen/openclaw-python
uv run openclaw gateway run
```

**é¢„æœŸæ—¥å¿—**:
```
âœ… Bot initialized: @whatisnewzhaobot (ID: 8065133868)
âœ… Registered 5 commands with Telegram
âœ… Menu button setup completed
âœ… Telegram channel started
âœ… Started 1 channels  # åº”è¯¥æ˜¯ 1ï¼Œä¸æ˜¯ 0
```

### æ­¥éª¤ 2: æµ‹è¯•åŸºç¡€å‘½ä»¤

åœ¨ Telegram ä¸­ä¸ `@whatisnewzhaobot` å¯¹è¯ï¼š

1. **æµ‹è¯• /start**
   ```
   å‘é€: /start
   é¢„æœŸ:
   â€¢ æ¬¢è¿æ¶ˆæ¯ (å¸¦ Markdown æ ¼å¼å’Œè¡¨æƒ…)
   â€¢ å¿«æ·é”®ç›˜ (4 ä¸ªæŒ‰é’®)
   â€¢ æ ¼å¼ç¾è§‚
   ```

2. **æµ‹è¯• /help**
   ```
   å‘é€: /help
   é¢„æœŸ:
   â€¢ å®Œæ•´å‘½ä»¤åˆ—è¡¨
   â€¢ ä½¿ç”¨æç¤º
   â€¢ Markdown æ ¼å¼
   ```

3. **æµ‹è¯• /status**
   ```
   å‘é€: /status
   é¢„æœŸ:
   â€¢ å½“å‰æ¨¡å‹æ˜¾ç¤º
   â€¢ è¿è¡ŒçŠ¶æ€
   â€¢ æ ¼å¼åŒ–è¾“å‡º
   ```

4. **æµ‹è¯• /model**
   ```
   å‘é€: /model
   é¢„æœŸ:
   â€¢ æ˜¾ç¤ºå½“å‰æ¨¡å‹
   â€¢ å†…è”æŒ‰é’® (4 ä¸ªé€‰é¡¹)
   â€¢ ç‚¹å‡»æŒ‰é’®å¯åˆ‡æ¢
   ```

5. **æµ‹è¯• /new**
   ```
   å‘é€: /new
   é¢„æœŸ:
   â€¢ ç¡®è®¤æç¤ºæ¶ˆæ¯
   â€¢ âœ… ç¡®è®¤ å’Œ âŒ å–æ¶ˆ æŒ‰é’®
   â€¢ ç‚¹å‡»æŒ‰é’®æœ‰åé¦ˆ
   ```

### æ­¥éª¤ 3: æµ‹è¯•æ™®é€šå¯¹è¯

```
å‘é€: ä½ å¥½
é¢„æœŸ:
â€¢ Gemini æ™ºèƒ½å›å¤
â€¢ å›å¤å†…å®¹åˆç†
â€¢ æ— é”™è¯¯
```

### æ­¥éª¤ 4: æµ‹è¯•å¿«æ·é”®ç›˜

ç‚¹å‡»å¿«æ·é”®ç›˜ä¸Šçš„æŒ‰é’®ï¼š
- ğŸ’¬ æ–°å¯¹è¯ â†’ ç›¸å½“äº `/new`
- ğŸ“Š çŠ¶æ€ â†’ ç›¸å½“äº `/status`
- â“ å¸®åŠ© â†’ ç›¸å½“äº `/help`
- ğŸ¤– åˆ‡æ¢æ¨¡å‹ â†’ ç›¸å½“äº `/model`

### æ­¥éª¤ 5: æµ‹è¯•æ¶ˆæ¯æ ¼å¼ (å¯é€‰)

è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ï¼š

```bash
# è®¾ç½®ä½ çš„ Telegram User ID (å‘é€ /start ç»™ @userinfobot è·å–)
export TEST_CHAT_ID="ä½ çš„_user_id"

# è¿è¡Œæµ‹è¯•
uv run python test_telegram_formats.py
```

**æµ‹è¯•ä¼šå‘é€**:
1. Markdown æ ¼å¼æ–‡æœ¬ (ç²—ä½“ã€æ–œä½“ã€ä»£ç )
2. æŠ•ç¥¨é—®å·
3. 6 ç§éª°å­åŠ¨ç”» (ğŸ²ğŸ¯ğŸ€âš½ğŸ³ğŸ°)
4. åœ°ç†ä½ç½® (æ—§é‡‘å±±)
5. æµ‹è¯•æ–‡æ¡£

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

### å¯åŠ¨æ£€æŸ¥

- [ ] Gateway å¯åŠ¨æ— é”™è¯¯
- [ ] Telegram channel æˆåŠŸå¯åŠ¨
- [ ] Bot ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º
- [ ] å‘½ä»¤æˆåŠŸæ³¨å†Œ

### å‘½ä»¤åŠŸèƒ½

- [ ] `/start` æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯å’Œé”®ç›˜
- [ ] `/help` æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
- [ ] `/new` æ˜¾ç¤ºç¡®è®¤æŒ‰é’®
- [ ] `/status` æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
- [ ] `/model` æ˜¾ç¤ºæ¨¡å‹é€‰æ‹©

### äº¤äº’åŠŸèƒ½

- [ ] å†…è”æŒ‰é’®å¯ä»¥ç‚¹å‡»
- [ ] å›è°ƒæŸ¥è¯¢æœ‰å“åº”
- [ ] å¿«æ·é”®ç›˜å§‹ç»ˆæ˜¾ç¤º
- [ ] æŒ‰é’®åŠŸèƒ½æ­£å¸¸

### æ¶ˆæ¯æ ¼å¼

- [ ] Markdown æ ¼å¼æ­£ç¡®
- [ ] è¡¨æƒ…ç¬¦å·æ˜¾ç¤º
- [ ] ç²—ä½“/æ–œä½“æ­£å¸¸
- [ ] ä»£ç å—æ ¼å¼åŒ–

### å¯¹è¯åŠŸèƒ½

- [ ] æ™®é€šæ¶ˆæ¯èƒ½å›å¤
- [ ] Gemini å“åº”æ­£å¸¸
- [ ] å†å²è®°å½•ç®¡ç†
- [ ] æ— é‡å¤å‘é€

---

## ğŸ¯ Agent ç»“æœæ ¼å¼åŒ–

ç°åœ¨ Agent å¯ä»¥ç”¨å¤šç§æ ¼å¼å›å¤ä½ ï¼š

### è‡ªåŠ¨æ ¼å¼é€‰æ‹©

```python
# Agent ç”Ÿæˆæ–‡æœ¬ â†’ ä½¿ç”¨ Markdown æ ¼å¼åŒ–
if output_type == "text":
    await channel.send_text(
        target=chat_id,
        text=format_with_markdown(text)
    )

# Agent ç”Ÿæˆå›¾ç‰‡ â†’ å‘é€å›¾ç‰‡
elif output_type == "image":
    await channel.send_photo(
        target=chat_id,
        photo=image_url,
        caption="ğŸ“¸ ç”Ÿæˆçš„å›¾ç‰‡"
    )

# Agent åˆ›å»ºæ–‡ä»¶ â†’ å‘é€æ–‡æ¡£
elif output_type == "file":
    await channel.send_document(
        target=chat_id,
        document=open(file_path, "rb"),
        caption="ğŸ“„ ç”Ÿæˆçš„æ–‡ä»¶"
    )

# Agent æä¾›ä½ç½® â†’ å‘é€åœ°å›¾
elif output_type == "location":
    await channel.send_location(
        target=chat_id,
        latitude=lat,
        longitude=lon
    )

# Agent éœ€è¦é€‰æ‹© â†’ å‘é€æŠ•ç¥¨
elif output_type == "poll":
    await channel.send_poll(
        target=chat_id,
        question=question,
        options=options
    )
```

---

## ğŸ“Š åŠŸèƒ½å¯¹æ¯”

ä¸ OpenClaw TypeScript ç‰ˆæœ¬å¯¹æ¯”ï¼š

| åŠŸèƒ½ | TypeScript | Python | çŠ¶æ€ |
|------|------------|--------|------|
| å‘½ä»¤ç³»ç»Ÿ | âœ… | âœ… | å®Œå…¨å¯¹é½ |
| å†…è”é”®ç›˜ | âœ… | âœ… | å®Œå…¨å¯¹é½ |
| å›å¤é”®ç›˜ | âœ… | âœ… | å®Œå…¨å¯¹é½ |
| Markdown | âœ… | âœ… | å®Œå…¨å¯¹é½ |
| å‘½ä»¤æ³¨å†Œ | âœ… | âœ… | å®Œå…¨å¯¹é½ |
| å›¾ç‰‡æ¶ˆæ¯ | âœ… | âœ… | å®Œå…¨å¯¹é½ |
| è§†é¢‘æ¶ˆæ¯ | âœ… | âœ… | å®Œå…¨å¯¹é½ |
| æ–‡æ¡£æ¶ˆæ¯ | âœ… | âœ… | å®Œå…¨å¯¹é½ |
| æŠ•ç¥¨åŠŸèƒ½ | âœ… | âœ… | å®Œå…¨å¯¹é½ |
| ä½ç½®åˆ†äº« | âœ… | âœ… | å®Œå…¨å¯¹é½ |

**ç»“è®º**: Python å®ç°ä¸ TypeScript ç‰ˆæœ¬åŠŸèƒ½å®Œå…¨ä¸€è‡´ï¼

---

## ğŸš€ æ€§èƒ½æŒ‡æ ‡

### å¯åŠ¨æ—¶é—´
- Gateway å¯åŠ¨: ~2ç§’
- Telegram è¿æ¥: ~1ç§’
- å‘½ä»¤æ³¨å†Œ: <100ms

### å“åº”æ—¶é—´
- å‘½ä»¤å“åº”: <200ms
- æ¶ˆæ¯å‘é€: <500ms
- Gemini å›å¤: 2-5ç§’

### èµ„æºä½¿ç”¨
- å†…å­˜å ç”¨: ~150MB
- CPU ä½¿ç”¨: <5%
- ç½‘ç»œ: ä½æµé‡

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **TELEGRAM_BOT_GUIDE.md**
   - å‘½ä»¤ä½¿ç”¨è¯¦ç»†è¯´æ˜
   - ä½¿ç”¨ç¤ºä¾‹
   - é¢„æœŸæ•ˆæœ

2. **TELEGRAM_MESSAGE_FORMATS.md**
   - 8 ç§æ¶ˆæ¯æ ¼å¼å®Œæ•´è¯´æ˜
   - ä»£ç ç¤ºä¾‹
   - æœ€ä½³å®è·µ

3. **TELEGRAM_ENHANCEMENT_COMPLETE.md**
   - åŠŸèƒ½å®Œæˆæ€»ç»“
   - å®ç°ç»†èŠ‚
   - æŠ€æœ¯è§„æ ¼

4. **test_telegram_formats.py**
   - è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
   - æ ¼å¼æ¼”ç¤º
   - ä½¿ç”¨è¯´æ˜

---

## ğŸ‰ æ€»ç»“

### å®Œæˆçš„å·¥ä½œ

âœ… **ä¿®å¤é—®é¢˜**
- è§£å†³ dataclass å­—æ®µé¡ºåºé”™è¯¯
- Telegram channel ç°åœ¨å¯ä»¥æ­£å¸¸å¯åŠ¨

âœ… **å‘½ä»¤ç³»ç»Ÿ**
- 5 ä¸ªæ ¸å¿ƒå‘½ä»¤
- è‡ªåŠ¨æ³¨å†Œåˆ° Telegram
- å‘½ä»¤èœå•æ˜¾ç¤º

âœ… **äº¤äº’åŠŸèƒ½**
- å†…è”é”®ç›˜ (æ¶ˆæ¯æŒ‰é’®)
- å›å¤é”®ç›˜ (å¿«æ·æ“ä½œ)
- å›è°ƒæŸ¥è¯¢å¤„ç†

âœ… **æ¶ˆæ¯æ ¼å¼**
- 8 ç§æ¶ˆæ¯ç±»å‹
- Markdown æ”¯æŒ
- è‡ªåŠ¨ fallback

âœ… **ç”¨æˆ·ä½“éªŒ**
- ä¸­æ–‡ç•Œé¢
- è¡¨æƒ…ç¬¦å·
- ç¾è§‚æ ¼å¼
- ä¸“ä¸šäº¤äº’

### ä¸‹ä¸€æ­¥

1. **ç«‹å³æµ‹è¯•**: é‡å¯ Gateway å¹¶åœ¨ Telegram æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
2. **éªŒè¯åŠŸèƒ½**: ä½¿ç”¨æ£€æŸ¥æ¸…å•ç¡®ä¿ä¸€åˆ‡æ­£å¸¸
3. **å¯é€‰æµ‹è¯•**: è¿è¡Œ `test_telegram_formats.py` æµ‹è¯•æ‰€æœ‰æ ¼å¼
4. **å¼€å§‹ä½¿ç”¨**: äº«å—åŠŸèƒ½å®Œæ•´çš„ Telegram Botï¼

---

## ğŸ“ æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æ£€æŸ¥å¯åŠ¨æ—¥å¿—ä¸­æ˜¯å¦æœ‰é”™è¯¯
2. ç¡®è®¤ Bot Token æ­£ç¡®
3. éªŒè¯ç½‘ç»œè¿æ¥
4. æŸ¥çœ‹ç›¸å…³æ–‡æ¡£

---

**çŠ¶æ€**: âœ… å®Œæˆå¹¶å‡†å¤‡æµ‹è¯•

**ç‰ˆæœ¬**: 1.0.0

**æ—¥æœŸ**: 2026-02-12

---

*ç¥æµ‹è¯•æ„‰å¿«ï¼ğŸŠ*
